# Supabase DB 테이블 설계

## 🧾 Supabase DB 테이블 설계

### 1. 🧑‍💼 `users` (Supabase 기본 제공)

> Supabase의 인증 기능을 사용하면 자동 생성됩니다.
> 

```sql

-- Supabase 인증 시스템을 통해 관리
id UUID PRIMARY KEY
email TEXT
created_at TIMESTAMP

```

---

### 2. 📋 `mandalarts` — 만다라트 전체 문서

```sql

CREATE TABLE mandalarts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  is_template BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

```

🔹 **인덱스 추천**

```sql

CREATE INDEX idx_user_id ON mandalarts(user_id);

```

---

### 3. 🟦 `mandalart_cells` — 81칸 각각의 셀 데이터

```sql

CREATE TABLE mandalart_cells (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mandalart_id UUID REFERENCES mandalarts(id) ON DELETE CASCADE,
  position INT NOT NULL CHECK (position >= 0 AND position < 81),
  topic TEXT,               -- 10자 이내 제한은 프론트/로직에서 처리
  memo TEXT,
  image_url TEXT,
  color TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

```

🔹 **중복 방지 제약**

```sql

-- 하나의 만다라트 안에서 position 중복 방지
CREATE UNIQUE INDEX idx_mandalart_cell_unique ON mandalart_cells(mandalart_id, position);

```

---

### 4. 📦 (선택) `templates` — 템플릿 정보 관리 (is_template과 별도 관리 시)

> 만다라트를 그대로 복제해 생성하는 구조라면 별도 테이블 없이 mandalarts.is_template = TRUE로 구분해도 충분합니다.
> 
> 
> 하지만 다양한 메타데이터(카테고리, 태그, 미리보기 이미지 등)를 붙일 계획이라면 아래처럼 별도 `templates` 테이블 사용 가능.
> 

```sql

CREATE TABLE templates (
  id UUID PRIMARY KEY,
  mandalart_id UUID REFERENCES mandalarts(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  preview_image_url TEXT,
  category TEXT,  -- ex: "자기계발", "학업"
  created_at TIMESTAMP DEFAULT NOW()
);

```

---

## 🧠 데이터 관계도

```

users
  └── mandalarts
          └── mandalart_cells (81개)

```

---

## ✅ 데이터 저장 흐름 예시 (새 만다라트 만들기)

1. `mandalarts` 테이블에 새 문서 1건 삽입 → 생성된 `id` 반환
2. `mandalart_cells`에 `position` 0~80번까지 빈 데이터 삽입 (또는 템플릿 기반 내용 삽입)
3. 이후 각 칸 클릭 시 개별 업데이트

---

## 📌 보안 정책 (Row-Level Security)

Supabase에서는 아래 RLS 정책 설정이 필요합니다:

### `mandalarts` RLS 예시:

```sql

-- 사용자는 본인의 문서만 접근 가능
CREATE POLICY "Allow user access to own mandalarts"
  ON mandalarts
  FOR ALL
  USING (user_id = auth.uid());

```

### `mandalart_cells` RLS 예시:

```sql

-- 사용자는 자신의 만다라트에 속한 셀만 접근 가능
CREATE POLICY "Allow user access to own cells"
  ON mandalart_cells
  FOR ALL
  USING (
    mandalart_id IN (
      SELECT id FROM mandalarts WHERE user_id = auth.uid()
    )
  );

```